generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agency {
  id             String           @id @default(cuid())
  nome           String
  email          String           @unique
  password       String
  citta          String
  widgetId       String           @unique @map("widget_id")
  piano          String           @default("free")
  attiva         Boolean          @default(true)
  dataCreazione  DateTime         @default(now()) @map("data_creazione")
  indirizzo      String?
  logoUrl        String?          @map("logo_url")
  partitaIva     String?          @map("partita_iva")
  sitoWeb        String?          @map("sito_web")
  telefono       String?
  affiliateId    String?          @map("affiliate_id")
  affiliate      Affiliate?       @relation(fields: [affiliateId], references: [id])
  sessions       AgencySession[]
  settings       AgencySetting?
  analytics      AnalyticsDaily[]
  auditLogs      AuditLog[]
  emailTemplates EmailTemplate[]
  leadStatuses   LeadStatus[]
  leads          Lead[]
  notifications  Notification[]
  subscription   Subscription?
  widgetConfigs  WidgetConfig[]

  @@index([affiliateId])
  @@map("agencies")
}

model Lead {
  id            String         @id @default(cuid())
  agenziaId     String         @map("agenzia_id")
  nome          String
  cognome       String
  email         String
  telefono      String?
  dataRichiesta DateTime       @default(now()) @map("data_richiesta")
  conversation  Conversation?
  statuses      LeadStatus[]
  agenzia       Agency         @relation(fields: [agenziaId], references: [id], onDelete: Cascade)
  notifications Notification[]
  property      Property?

  @@index([agenziaId])
  @@index([dataRichiesta])
  @@map("leads")
}

model Property {
  id               String               @id @default(cuid())
  leadId           String               @unique @map("lead_id")
  indirizzo        String
  citta            String
  cap              String?
  latitudine       Float?
  longitudine      Float?
  tipo             String
  superficieMq     Int                  @map("superficie_mq")
  piano            Int?
  ascensore        Boolean?
  stato            String
  quartiere        String?
  locali           Int?
  bagni            Int?
  tipoPiano        String?              @map("tipo_piano")
  spaziEsterni     String?              @map("spazi_esterni")
  postoAuto        Boolean?             @map("posto_auto")
  riscaldamento    String?
  ariaCondizionata Boolean?             @map("aria_condizionata")
  classeEnergetica String?              @map("classe_energetica")
  annoCostruzione  Int?                 @map("anno_costruzione")
  statoOccupazione String?              @map("stato_occupazione")
  dataScadenza     String?              @map("data_scadenza")
  lead             Lead                 @relation(fields: [leadId], references: [id], onDelete: Cascade)
  attachments      PropertyAttachment[]
  valuation        Valuation?

  @@index([leadId])
  @@map("properties")
}

model Valuation {
  id                String   @id @default(cuid())
  immobileId        String   @unique @map("immobile_id")
  prezzoMinimo      Int      @map("prezzo_minimo")
  prezzoMassimo     Int      @map("prezzo_massimo")
  prezzoStimato     Int      @map("prezzo_stimato")
  valoreOmiBase     Int      @map("valore_omi_base")
  coefficientePiano Float    @map("coefficiente_piano")
  coefficienteStato Float    @map("coefficiente_stato")
  spiegazione       String
  dataCalcolo       DateTime @default(now()) @map("data_calcolo")
  property          Property @relation(fields: [immobileId], references: [id], onDelete: Cascade)

  @@index([immobileId])
  @@map("valuations")
}

model Conversation {
  id        String   @id @default(cuid())
  leadId    String   @unique @map("lead_id")
  messaggi  Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("conversations")
}

model DemoLead {
  id            String   @id @default(cuid())
  nome          String
  cognome       String
  email         String
  telefono      String?
  indirizzo     String
  citta         String
  tipo          String
  superficieMq  Int      @map("superficie_mq")
  piano         Int?
  ascensore     Boolean?
  stato         String
  prezzoMinimo  Int      @map("prezzo_minimo")
  prezzoMassimo Int      @map("prezzo_massimo")
  prezzoStimato Int      @map("prezzo_stimato")
  messaggi      Json
  dataRichiesta DateTime @default(now()) @map("data_richiesta")

  @@index([dataRichiesta])
  @@index([email])
  @@map("demo_leads")
}

model AgencySession {
  id             String    @id @default(cuid())
  agencyId       String    @map("agency_id")
  tokenHash      String    @map("token_hash")
  ipAddress      String?   @map("ip_address")
  userAgent      String?   @map("user_agent")
  loginAt        DateTime  @default(now()) @map("login_at")
  expiresAt      DateTime  @map("expires_at")
  lastActivityAt DateTime  @default(now()) @map("last_activity_at")
  revokedAt      DateTime? @map("revoked_at")
  agency         Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("agency_sessions")
}

model LeadStatus {
  id                String   @id @default(cuid())
  leadId            String   @map("lead_id")
  status            String   @default("NEW")
  note              String?
  createdByAgencyId String   @map("created_by_agency_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  createdBy         Agency   @relation(fields: [createdByAgencyId], references: [id], onDelete: Cascade)
  lead              Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([status])
  @@map("lead_statuses")
}

model Subscription {
  id                       String    @id @default(cuid())
  agencyId                 String    @unique @map("agency_id")
  planType                 String    @default("free") @map("plan_type")
  status                   String    @default("active")
  trialEndsAt              DateTime? @map("trial_ends_at")
  nextBillingDate          DateTime? @map("next_billing_date")
  cancelledAt              DateTime? @map("cancelled_at")
  paymentMethodId          String?   @map("payment_method_id")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  stripeCustomerId         String?   @unique @map("stripe_customer_id")
  stripePriceId            String?   @map("stripe_price_id")
  stripeSubscriptionId     String?   @unique @map("stripe_subscription_id")
  extraValuationsPurchased Int       @default(0) @map("extra_valuations_purchased")
  valuationsResetDate      DateTime? @map("valuations_reset_date")
  valuationsUsedThisMonth  Int       @default(0) @map("valuations_used_this_month")
  onboardingCompletedAt    DateTime? @map("onboarding_completed_at")
  trialDays                Int?      @map("trial_days")
  agency                   Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([nextBillingDate])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model PromoCode {
  id              String    @id @default(cuid())
  code            String    @unique
  discountPercent Int       @map("discount_percent")
  maxUses         Int?      @map("max_uses")
  usedCount       Int       @default(0) @map("used_count")
  stripeCouponId  String?   @map("stripe_coupon_id")
  expiresAt       DateTime? @map("expires_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([code])
  @@index([isActive])
  @@map("promo_codes")
}

model AuditLog {
  id         String   @id @default(cuid())
  agencyId   String?  @map("agency_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  agency     Agency?  @relation(fields: [agencyId], references: [id])

  @@index([agencyId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

model AgencySetting {
  id                 String   @id @default(cuid())
  agencyId           String   @unique @map("agency_id")
  notificationsEmail Boolean  @default(true) @map("notifications_email")
  emailOnNewLead     Boolean  @default(true) @map("email_on_new_lead")
  timeZone           String   @default("Europe/Rome") @map("time_zone")
  language           String   @default("it")
  widgetTheme        String   @default("default") @map("widget_theme")
  customCss          String?  @map("custom_css")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  brandColors        Json?    @map("brand_colors")
  dateFormat         String   @default("DD/MM/YYYY") @map("date_format")
  agency             Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@map("agency_settings")
}

model PropertyAttachment {
  id         String   @id @default(cuid())
  propertyId String   @map("property_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileType   String   @map("file_type")
  fileSize   Int      @map("file_size")
  purpose    String
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("property_attachments")
}

model Notification {
  id        String    @id @default(cuid())
  agencyId  String    @map("agency_id")
  type      String
  leadId    String?   @map("lead_id")
  title     String
  message   String
  isRead    Boolean   @default(false) @map("is_read")
  createdAt DateTime  @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")
  agency    Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  lead      Lead?     @relation(fields: [leadId], references: [id])

  @@index([agencyId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AnalyticsDaily {
  id                  String   @id @default(cuid())
  agencyId            String   @map("agency_id")
  date                DateTime @db.Date
  widgetImpressions   Int      @default(0) @map("widget_impressions")
  widgetClicks        Int      @default(0) @map("widget_clicks")
  leadsGenerated      Int      @default(0) @map("leads_generated")
  valuationsCompleted Int      @default(0) @map("valuations_completed")
  conversionRate      Float    @default(0) @map("conversion_rate")
  createdAt           DateTime @default(now()) @map("created_at")
  agency              Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([agencyId, date])
  @@index([date])
  @@map("analytics_daily")
}

model WidgetEvent {
  id        String   @id @default(cuid())
  widgetId  String   @map("widget_id")
  leadId    String?  @map("lead_id")
  eventType String   @map("event_type")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([widgetId])
  @@index([eventType])
  @@index([createdAt])
  @@map("widget_events")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  agencyId  String?  @map("agency_id")
  name      String
  subject   String
  htmlBody  String   @map("html_body")
  textBody  String   @map("text_body")
  variables Json?
  type      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  agency    Agency?  @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([type])
  @@map("email_templates")
}

model WidgetConfig {
  id              String   @id @default(cuid())
  agencyId        String   @map("agency_id")
  widgetId        String   @unique @map("widget_id")
  name            String
  mode            String   @default("bubble")
  isActive        Boolean  @default(true) @map("is_active")
  isDefault       Boolean  @default(false) @map("is_default")
  themeName       String   @default("default") @map("theme_name")
  primaryColor    String   @default("#2563eb") @map("primary_color")
  secondaryColor  String?  @map("secondary_color")
  backgroundColor String   @default("#ffffff") @map("background_color")
  textColor       String   @default("#1f2937") @map("text_color")
  fontFamily      String   @default("system-ui") @map("font_family")
  borderRadius    String   @default("8px") @map("border_radius")
  buttonStyle     String   @default("rounded") @map("button_style")
  bubblePosition  String   @default("bottom-right") @map("bubble_position")
  bubbleIcon      String?  @map("bubble_icon")
  showBadge       Boolean  @default(true) @map("show_badge")
  bubbleAnimation String   @default("pulse") @map("bubble_animation")
  inlineHeight    String   @default("600px") @map("inline_height")
  showHeader      Boolean  @default(true) @map("show_header")
  showBorder          Boolean  @default(true) @map("show_border")
  customCss           String?  @map("custom_css")
  logoUrl             String?  @map("logo_url")
  sendButtonColor     String?  @map("send_button_color")
  sendButtonIconColor String?  @map("send_button_icon_color")
  impressions         Int      @default(0)
  leadsGenerated      Int      @default(0) @map("leads_generated")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  agency              Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([widgetId])
  @@index([isActive])
  @@map("widget_configs")
}

model OMIValue {
  id                String   @id @default(cuid())
  citta             String
  zona              String
  cap               String?
  tipoImmobile      String   @map("tipo_immobile")
  categoria         String?
  valoreMinMq       Decimal  @map("valore_min_mq") @db.Decimal(10, 2)
  valoreMaxMq       Decimal  @map("valore_max_mq") @db.Decimal(10, 2)
  valoreMedioMq     Decimal  @map("valore_medio_mq") @db.Decimal(10, 2)
  semestre          Int
  anno              Int
  fonte             String   @default("OMI")
  dataAggiornamento DateTime @default(now()) @map("data_aggiornamento")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([citta, zona, tipoImmobile, categoria, anno, semestre], name: "OMIValue_unique")
  @@index([citta, zona])
  @@index([cap])
  @@index([anno, semestre])
  @@map("omi_values")
}

model PriceHistory {
  id                   String   @id @default(cuid())
  citta                String
  zona                 String
  cap                  String?
  tipoImmobile         String   @map("tipo_immobile")
  valoreMinMq          Decimal  @map("valore_min_mq") @db.Decimal(10, 2)
  valoreMaxMq          Decimal  @map("valore_max_mq") @db.Decimal(10, 2)
  valoreMedioMq        Decimal  @map("valore_medio_mq") @db.Decimal(10, 2)
  semestre             Int
  anno                 Int
  variazionePrecedente Decimal? @map("variazione_precedente") @db.Decimal(5, 2)
  numeroTransazioni    Int?     @map("numero_transazioni")
  fonte                String   @default("OMI")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@unique([citta, zona, tipoImmobile, anno, semestre], name: "PriceHistory_unique")
  @@index([citta, zona])
  @@index([cap])
  @@index([anno, semestre])
  @@map("price_history")
}

model ZoneInsight {
  id                       String   @id @default(cuid())
  citta                    String
  zona                     String
  cap                      String?
  trend                    String
  variazioneAnnuale        Decimal  @map("variazione_annuale") @db.Decimal(5, 2)
  variazioneUltimoSemestre Decimal? @map("variazione_ultimo_semestre") @db.Decimal(5, 2)
  prezzoMedioAttuale       Decimal  @map("prezzo_medio_attuale") @db.Decimal(10, 2)
  descrizione              String?
  icona                    String?
  dataCalcolo              DateTime @default(now()) @map("data_calcolo")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  @@unique([citta, zona, dataCalcolo], name: "ZoneInsight_unique")
  @@index([citta, zona])
  @@index([cap])
  @@map("zone_insights")
}

model Affiliate {
  id           String             @id @default(cuid())
  email        String             @unique
  password     String
  nome         String
  cognome      String
  referralCode String             @unique @map("referral_code")
  attivo       Boolean            @default(true)
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  sessions     AffiliateSession[]
  agencies     Agency[]

  @@map("affiliates")
}

model AffiliateSession {
  id             String    @id @default(cuid())
  affiliateId    String    @map("affiliate_id")
  tokenHash      String    @map("token_hash")
  ipAddress      String?   @map("ip_address")
  userAgent      String?   @map("user_agent")
  loginAt        DateTime  @default(now()) @map("login_at")
  expiresAt      DateTime  @map("expires_at")
  lastActivityAt DateTime  @default(now()) @map("last_activity_at")
  revokedAt      DateTime? @map("revoked_at")
  affiliate      Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("affiliate_sessions")
}
